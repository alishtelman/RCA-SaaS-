services:
  postgres:
    image: pgvector/pgvector:pg15
    container_name: rag-pg
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - ./data/db:/var/lib/postgresql/data
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: ./api/Dockerfile
    container_name: rag-api
    ports:
      - "${API_PORT:-8080}:8080"
    env_file:
      - .env
    depends_on:
      - postgres
    restart: unless-stopped
    volumes:
      - ./data/new_tickets:/data/new_tickets:ro
      - ./models:/app/models:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/readyz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  rag-cron:
    image: curlimages/curl:latest
    container_name: rag-cron
    environment:
      - CRON_SCHEDULE=0 4 * * 1
      - API_URL=http://rag-api:8080/manage/reindex
    entrypoint: ["/bin/sh","-lc"]
    command: |
      echo "$$CRON_SCHEDULE curl -s -X POST $$API_URL >/proc/1/fd/1 2>&1" > /etc/crontabs/root
      crond -f -l 8
    depends_on:
      - api

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    container_name: rag-ui
    environment:
      - API_URL=http://rag-api:8080
    ports:
      - "8501:8501"
    depends_on:
      - api
